<div class="flex items-center justify-between">
    <div class="text-white font-semibold text-lg">
        ${{ price | format_number(2, '.', ',') }} <small>AUD (incl. GST)</small>
    </div>
    <div class="flex items-center gap-4">
        <label class="text-white font-semibold" for="quantity">Quantity</label>
        <input id="quantity" type="number" min="1" step="1" value="1" class="w-24" oninput="validity.valid || (value=1)" />
    </div>
</div>
<div id="paypal-button-container"></div>

<script src="https://www.paypal.com/sdk/js?client-id={{ paypal:client_id }}&currency=AUD&disable-funding=card"></script>

<script>
    const title = '{{ title }}';
    const description = '{{ description }}';
    const itemPrice = {{ price }};
    const qtyField = document.getElementById('quantity');
    const currency = 'AUD'

    let quantity = parseInt(qtyField.value);

    qtyField.addEventListener('change', (e) => {
        qtyField.disabled = true;
        quantity = parseInt(e.target.value);
        renderButton();
    });

    function showMessage(text, type) {
        message.textContent = text;
        message.className = `block ${type}`;
    }

    function renderButton() {
        document.getElementById('paypal-button-container').innerHTML = '';

        paypal.Buttons({
            style: {
                layout: 'vertical',
                color: 'gold',
                shape: 'rect',
                label: 'paypal'
            },

            createOrder: function (data, actions) {
                return actions.order.create({
                    purchase_units: [{
                        description: description,
                        amount: {
                            currency_code: currency,
                            value: (itemPrice * quantity).toFixed(2),
                            breakdown: {
                                item_total: {
                                    currency_code: currency,
                                    value: (itemPrice * quantity).toFixed(2)
                                }
                            }
                        },
                        items: [{
                            name: title,
                            description: description,
                            unit_amount: {
                                currency_code: currency,
                                value: itemPrice.toFixed(2)
                            },
                            quantity: quantity.toString()
                        }]
                    }]
                });
            },

            onApprove: function (data, actions) {
                return actions.order.capture().then(function (details) {
                    showMessage(`Transaction completed by ${details.payer.name.given_name}!`, 'success');
                    console.log('Transaction details:', details);
                });
            },

            onError: function (err) {
                showMessage('An error occurred with your payment. Please try again.', 'error');
                console.error('PayPal error:', err);
            }

        }).render('#paypal-button-container').then(() => {
            qtyField.disabled = false;
        });
    }

    renderButton();
</script>

